// ============================================================================
// ملف MainApp.cpp - تنفيذ الكلاس الرئيسي للتطبيق
// ============================================================================
// هذا الملف يحتوي على الكلاس الرئيسي الذي يدير التطبيق بالكامل
// يتضمن إدارة الحالات (القائمة، المحاكاة، إلخ) وتنسيق جميع المكونات
// ============================================================================

// تضمين ملف تعريف الكلاس الرئيسي
#include "../include/MainApp.h"

// تضمين ملفات الرسم (القائمة، التعليمات، حول)
#include "../include/MenuRenderer.h"
#include "../include/HowToUseRenderer.h"
#include "../include/AboutRenderer.h"

// تضمين مكتبة OpenGL للرسومات ثلاثية الأبعاد
#include <GL/glut.h>

// تضمين مكتبة الإدخال/الإخراج القياسية (للطباعة)
#include <stdio.h>


//****

// ============================================================================
// متغير عام للوصول إلى الكائن الرئيسي من دوال Callback
// ============================================================================
// هذا المتغير يُستخدم للوصول إلى كائن MainApp من دوال GLUT Callback
// لأن دوال Callback في GLUT لا يمكنها استقبال معاملات إضافية
MainApp* MainApp::instance = NULL;

// ============================================================================
// دالة البناء Constructor - تقوم بإنشاء التطبيق الرئيسي
// ============================================================================
// هذه الدالة تستدعى عند إنشاء كائن MainApp
// تقوم بإنشاء جميع المكونات الأساسية للتطبيق
// ============================================================================
MainApp::MainApp() {
    // تعيين المتغير العام instance للإشارة إلى هذا الكائن
    // هذا يسمح لدوال Callback بالوصول إلى الكائن
    instance = this;
    
    // إنشاء مدير الصوت (للموسيقى والأصوات)
    audioMgr = new AudioManager();
    
    // إنشاء مدير حالة اللعبة (يدير القائمة والمحاكاة والحالات الأخرى)
    gameState = new GameStateManager();
    
    // إنشاء مدير النافذة (يدير النافذة والشاشة الكاملة)
    windowMgr = new WindowManager();
    
    // إنشاء الكاميرا (للتحكم في المشاهدة)
    camera = new Camera();
    
    // إنشاء حقل النجوم (الخلفية النجمية)
    starField = new StarField();
    
    // إنشاء النظام الشمسي (جميع الكواكب والشمس)
    solarSystem = new SolarSystem();
    
    // إنشاء الراسم (يدير رسم المشهد)
    // يتم تمرير حقل النجوم والنظام الشمسي والكاميرا إليه
    renderer = new Renderer(starField, solarSystem, camera);
    
    // إنشاء معالج الإدخال (يدير لوحة المفاتيح والماوس)
    // يتم تمرير مدير الحالة ومدير النافذة والكاميرا والنظام الشمسي إليه
    inputHandler = new InputHandler(gameState, windowMgr, camera, solarSystem);
}

// ============================================================================
// دالة الإتلاف Destructor - تقوم بحذف التطبيق من الذاكرة
// ============================================================================
// هذه الدالة تستدعى تلقائياً عند حذف التطبيق
// تقوم بتحرير الذاكرة المخصصة لجميع المكونات
// ============================================================================
MainApp::~MainApp() {
    // حذف جميع المكونات بالترتيب العكسي لإنشائها
    delete inputHandler;   // حذف معالج الإدخال
    delete renderer;       // حذف الراسم
    delete solarSystem;    // حذف النظام الشمسي
    delete starField;      // حذف حقل النجوم
    delete camera;         // حذف الكاميرا
    delete windowMgr;      // حذف مدير النافذة
    delete gameState;      // حذف مدير الحالة
    delete audioMgr;       // حذف مدير الصوت
}

// ============================================================================
// دالة التهيئة (Init) - تهيئة التطبيق
// ============================================================================
// هذه الدالة تستدعى بعد إنشاء التطبيق لتهيئة جميع الإعدادات
// ============================================================================
void MainApp::init() {
    // تهيئة مدير الصوت (تحميل الموسيقى والأصوات)
    audioMgr->init();
    
    // تهيئة إعدادات OpenGL (الإضاءة، الألوان، إلخ)
    renderer->initGL();

}

// ============================================================================
// دالة التشغيل (Run) - بدء الحلقة الرئيسية
// ============================================================================
// هذه الدالة تستدعى لبدء الحلقة الرئيسية للتطبيق
// تبقى مستمرة حتى إغلاق النافذة
// ============================================================================
void MainApp::run() {
    // بدء الحلقة الرئيسية لـ GLUT
    // هذه الدالة تبقى مستمرة حتى إغلاق النافذة
    glutMainLoop();
}

// ============================================================================
// دالة العرض (Display) - رسم المشهد الحالي
// ============================================================================
// هذه الدالة تستدعى في كل إطار لرسم المشهد الحالي
// تقوم بفحص الحالة الحالية ورسوم الشاشة المناسبة
// ============================================================================
void MainApp::display() {
    // فحص الحالة الحالية للعبة
    switch (gameState->getCurrentState()) {
        case MENU:  // إذا كانت الحالة هي القائمة
            // رسم القائمة مع زر محدد ووقت الرسوم المتحركة
            MenuRenderer::draw(gameState->getSelectedButton(), gameState->getMenuAnimTime());
            break;
            
        case SIMULATION:  // إذا كانت الحالة هي المحاكاة
            // رسم المحاكاة (النظام الشمسي)
            renderer->renderSimulation();
            break;
            
        case HOW_TO_USE:  // إذا كانت الحالة هي شاشة التعليمات
            // رسم شاشة التعليمات
            HowToUseRenderer::draw();
            break;
            
        case ABOUT:  // إذا كانت الحالة هي شاشة حول
            // رسم شاشة حول
            AboutRenderer::draw();
            break;
    }
}

// ============================================================================
// دالة التحديث (Update) - تحديث المحاكاة
// ============================================================================
// هذه الدالة تستدعى في كل إطار لتحديث المحاكاة
// تقوم بتحريك الوقت للأمام وتحديث الرسوم المتحركة
// ============================================================================
void MainApp::update() {
    // إذا كانت الحالة الحالية هي المحاكاة
    if (gameState->getCurrentState() == SIMULATION) {
        // تحديث النظام الشمسي (تحريك الوقت للأمام بمقدار 0.01 ثانية)
        solarSystem->update(0.01);//steo
    }
    
    // تحديث وقت الرسوم المتحركة للقائمة (0.016 ثانية ≈ 60 إطار في الثانية)
    gameState->updateMenuAnimTime(0.008f);
    
    // طلب إعادة رسم المشهد في الإطار التالي
    glutPostRedisplay();
}

// ============================================================================
// دالة تغيير الحجم (Reshape) - تحديث إعدادات العرض عند تغيير حجم النافذة
// ============================================================================
// هذه الدالة تستدعى عند تغيير حجم النافذة
// w, h: العرض والارتفاع الجديدان للنافذة (بالبكسل)
// ============================================================================

//***** */
void MainApp::reshape(int w, int h) {
    // تحديث منطقة الرسم (Viewport) لتطابق حجم النافذة الجديد
    glViewport(0, 0, w, h);
    
    // التبديل إلى مصفوفة الإسقاط (Projection Matrix)
    glMatrixMode(GL_PROJECTION);
    
    // تحميل مصفوفة الوحدة (إعادة تعيين)
    glLoadIdentity();
    
    // تعيين إسقاط المنظور (Perspective Projection)
    // 45.0: زاوية الرؤية (بالدرجات)
    // (float)w / (float)h: نسبة العرض إلى الارتفاع
    // 0.1: أقرب مسافة مرئية
    // 200.0: أبعد مسافة مرئية
    gluPerspective(45.0, (float)w / (float)h, 0.1, 200.0);
    
    // التبديل إلى مصفوفة النموذج (Modelview Matrix)
    glMatrixMode(GL_MODELVIEW);
}

// ============================================================================
// دوال Callback - للتعامل مع أحداث GLUT
// ============================================================================
// هذه الدوال تستدعى تلقائياً من GLUT عند حدوث أحداث معينة
// جميعها دوال ثابتة (static) لأن GLUT لا يمكنه استدعاء دوال غير ثابتة
// ============================================================================

// دالة Callback للعرض - تستدعى عند الحاجة لإعادة رسم المشهد
void MainApp::displayCallback() {
    // إذا كان هناك كائن MainApp موجود
    if (instance) 
        instance->display();  // استدعاء دالة العرض
}

// دالة Callback لتغيير الحجم - تستدعى عند تغيير حجم النافذة
void MainApp::reshapeCallback(int w, int h) {
    // إذا كان هناك كائن MainApp موجود
    if (instance) 
        instance->reshape(w, h);  // استدعاء دالة تغيير الحجم
}

// دالة Callback للتحديث - تستدعى بشكل دوري لتحديث المحاكاة
void MainApp::updateCallback(int value) {
    // إذا كان هناك كائن MainApp موجود
    if (instance) {
        instance->update();  // استدعاء دالة التحديث
        
        // جدولة استدعاء هذه الدالة مرة أخرى بعد 16 مللي ثانية
        // (16 مللي ثانية ≈ 60 إطار في الثانية)
        glutTimerFunc(16, updateCallback, 0);
    }
}

// دالة Callback للوحة المفاتيح - تستدعى عند الضغط على مفتاح عادي
void MainApp::keyboardCallback(unsigned char key, int x, int y) {
    // إذا كان هناك كائن MainApp موجود
    if (instance) 
        instance->inputHandler->handleKeyboard(key, x, y);  // تمرير الحدث لمعالج الإدخال
}

// دالة Callback للمفاتيح الخاصة - تستدعى عند الضغط على مفتاح خاص (F11, ESC, إلخ)
void MainApp::specialKeysCallback(int key, int x, int y) {
    // إذا كان هناك كائن MainApp موجود
    if (instance) 
        instance->inputHandler->handleSpecialKeys(key, x, y);  // تمرير الحدث لمعالج الإدخال
}

// دالة Callback للماوس - تستدعى عند الضغط أو رفع زر الماوس
void MainApp::mouseCallback(int button, int state, int x, int y) {
    // إذا كان هناك كائن MainApp موجود
    if (instance) 
        instance->inputHandler->handleMouse(button, state, x, y);  // تمرير الحدث لمعالج الإدخال
}

// دالة Callback لحركة الماوس - تستدعى عند تحريك الماوس أثناء الضغط
void MainApp::motionCallback(int x, int y) {
    // إذا كان هناك كائن MainApp موجود
    if (instance) 
        instance->inputHandler->handleMouseMotion(x, y);  // تمرير الحدث لمعالج الإدخال
}

// دالة Callback لحركة الماوس السلبية - تستدعى عند تحريك الماوس بدون ضغط
void MainApp::passiveMotionCallback(int x, int y) {
    // إذا كان هناك كائن MainApp موجود
    if (instance) 
        instance->inputHandler->handlePassiveMotion(x, y);  // تمرير الحدث لمعالج الإدخال
}

// ============================================================================
// دالة إعداد Callbacks - تسجيل جميع دوال Callback مع GLUT
// ============================================================================
// هذه الدالة تستدعى بعد تهيئة التطبيق لتسجيل جميع دوال Callback
// ============================================================================
void MainApp::setupCallbacks() {
    // تسجيل دالة Callback للعرض (رسم المشهد)
    glutDisplayFunc(displayCallback);
    
    // تسجيل دالة Callback لتغيير الحجم (عند تغيير حجم النافذة)
    glutReshapeFunc(reshapeCallback);
    
    // تسجيل دالة Callback للوحة المفاتيح (المفاتيح العادية)
    glutKeyboardFunc(keyboardCallback);
    
    // تسجيل دالة Callback للمفاتيح الخاصة (F11, ESC, إلخ)
    glutSpecialFunc(specialKeysCallback);
    
    // تسجيل دالة Callback للماوس (الضغط والرفع)
    glutMouseFunc(mouseCallback);
    
    // تسجيل دالة Callback لحركة الماوس (أثناء الضغط)
    glutMotionFunc(motionCallback);
    
    // تسجيل دالة Callback لحركة الماوس السلبية (بدون ضغط)
    glutPassiveMotionFunc(passiveMotionCallback);
    
    // جدولة دالة Callback للتحديث (بعد 16 مللي ثانية)
    glutTimerFunc(16, updateCallback, 0);
}
